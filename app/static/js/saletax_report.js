// /static/js/saletax_report.js
const API_LIST = "/api/saletax/list";
const API_SUMMARY = "/api/saletax/summary";

document.addEventListener("DOMContentLoaded", () => {

    const $$ = sel => document.querySelector(sel);

    const state = {
        granularity: "day",
        mode: "detail",
        split: false,
        dayFrom: null, dayTo: null, month: null, year: null,
        rows: []
    };

    // === ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≤‡∏ô‡∏π‡∏•‡∏≤‡∏£‡∏¥‡∏ï‡∏µ‡πâ ===
    document.querySelectorAll(".rg").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".rg").forEach(b => b.classList.remove("bg-white/20"));
            btn.classList.add("bg-white/20");
            state.granularity = btn.dataset.gran;
            toggleFilters();
            buildReport();
        });
    });

    // === ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ===
    document.querySelector('.rg[data-gran="day"]')?.classList.add("bg-white/20");
    toggleFilters();

    const today = new Date();
    $$("#dayFrom").value = ymd(firstDayOfMonth(today));
    $$("#dayTo").value = ymd(lastDayOfMonth(today));
    $$("#monthPick").value = ymd(today).slice(0, 7);
    $$("#yearPick").value = String(today.getFullYear());

    // === ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° ===
    $$("#apply").addEventListener("click", buildReport);
    $$("#btnPrint").addEventListener("click", () => window.print());
    document.getElementById("btnExcel")?.addEventListener("click", exportExcel);

    // === ‡πÇ‡∏´‡∏°‡∏î/‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ===
    $$("#mode")?.addEventListener("change", () => state.mode = $$("#mode").value);
    $$("#splitCompany")?.addEventListener("change", () => state.split = $$("#splitCompany").checked);

    // === ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ===
    buildReport();

    function toggleFilters() {
        const g = state.granularity;
        $$("#f-day").classList.toggle("hidden", g !== "day");
        $$("#f-month").classList.toggle("hidden", g !== "month");
        $$("#f-year").classList.toggle("hidden", g !== "year");
    }

    function readFilters() {
        state.mode = $$("#mode").value;
        state.split = $$("#splitCompany").checked;
        if (state.granularity === "day") {
            state.dayFrom = $$("#dayFrom").value || null;
            state.dayTo = $$("#dayTo").value || null;
        } else if (state.granularity === "month") {
            state.month = $$("#monthPick").value || null;
        } else {
            state.year = parseInt($$("#yearPick").value || "", 10) || null;
        }
    }

    // === util ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô-‡∏õ‡∏µ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ ===
    function thaiMonthYear({ granularity, dayFrom, month, year }) {
        const thMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
            "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

        const toBE = y => (y + 543);
        if (granularity === "month" && month) {
            // month ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM
            const [y, m] = month.split("-").map(x => parseInt(x, 10));
            return `${thMonths[(m || 1) - 1]} ‡∏õ‡∏µ ${toBE(y || new Date().getFullYear())}`;
        }
        if (granularity === "day" && dayFrom) {
            const d = new Date(dayFrom);
            return `${thMonths[d.getMonth()]} ‡∏õ‡∏µ ${toBE(d.getFullYear())}`;
        }
        // year ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const y = year || new Date().getFullYear();
        return `‡∏õ‡∏µ ${toBE(y)}`;
    }


    async function buildReport() {
        readFilters();
        // ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞ month-year
        const monthYearText = thaiMonthYear({
            granularity: state.granularity,
            dayFrom: state.dayFrom,
            month: state.month,
            year: state.year
        });
        document.querySelector(".month-year").textContent = monthYearText;

        const g = state.granularity, mode = state.mode, split = state.split;

        // subtitle
        let sub = g === "day"
            ? `‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ${state.dayFrom || "-"} ‡∏ñ‡∏∂‡∏á ${state.dayTo || "-"}`
            : (g === "month" ? `‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${state.month || "-"}` : `‡∏£‡∏≤‡∏¢‡∏õ‡∏µ: ${state.year || "-"}`);
        if (split) sub += " ‚Ä¢ ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó";
        $$("#subtitle").textContent = sub;

        // fetch
        try {
            let url, params = new URLSearchParams();
            if (g === "day") { if (state.dayFrom) params.set("start", state.dayFrom); if (state.dayTo) params.set("end", state.dayTo); }
            if (g === "month") { if (state.month) params.set("month", state.month); }
            if (g === "year") { if (state.year) params.set("year", state.year); }

            if (mode === "summary") {
                params.set("granularity", g);
                if (split) params.set("split_by_company", "true");
                url = `${API_SUMMARY}?${params}`;
            } else {
                url = `${API_LIST}?${params}`;
            }

            const res = await fetch(url, { headers: { "Accept": "application/json" } });
            if (!res.ok) throw new Error(await res.text());
            const rows = await res.json();
            state.rows = Array.isArray(rows) ? rows : [];
            renderReport();
        } catch (e) {
            console.error(e);
            state.rows = [];
            renderReport();
            alert("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    }

    function renderReport() {
        const body = $$("#reportBody");
        body.innerHTML = "";
        let count = 0, before = 0, grand = 0;

        // ‡πÇ‡∏´‡∏°‡∏î "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)" ‡πÅ‡∏•‡∏∞ "‡πÑ‡∏°‡πà‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" -> ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏Ç‡∏≤‡∏¢
        if (state.mode === "detail" && !state.split) {
            const { table, tbody } = makeSaleTaxTable(); // üëà ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö
            state.rows.forEach((r, idx) => {
                count += 1;
                before += Number(r.before_vat) || 0;
                grand += Number(r.grand) || 0;

                const branchText = (r.cf_hq === 1 || r.cf_hq === "1") ? "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà" :
                    (r.cf_branch ? `‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà ${r.cf_branch}` : "-");

                const tr = document.createElement("tr");
                tr.innerHTML = `
        <td class="c c-center">${idx + 1}</td>
        <td class="c">${fmtThaiDate(r.invoice_date)}</td>
        <td class="c c-center">-</td> <!-- ‡πÄ‡∏•‡πà‡∏°‡∏ó‡∏µ‡πà (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -> '-') -->
        <td class="c">${r.invoice_number || "-"}</td>
        <td class="c">${r.personid || "-"}</td>
        <td class="c">${r.company || "-"}</td>
        <td class="c">${r.cf_taxid || "-"}</td>
        <td class="c c-center">${branchText}</td>
        <td class="c c-right">${fmtNum(r.before_vat)}</td>
        <td class="c c-right">${fmtNum(r.vat)}</td>
        <td class="c c-right">${fmtNum(r.grand)}</td>
      `;
                tbody.appendChild(tr);
            });

            // summary row (optional)
            const trSum = document.createElement("tr");
            trSum.className = "sum-row";
            trSum.innerHTML = `
      <td class="c" colspan="8" style="text-align:right;font-weight:700;">‡∏£‡∏ß‡∏°</td>
      <td class="c c-right"><b>${fmtNum(before)}</b></td>
      <td class="c c-right"><b>${fmtNum(before * 0.07)}</b></td>
      <td class="c c-right"><b>${fmtNum(grand)}</b></td>
    `;
            tbody.appendChild(trSum);

            body.appendChild(table);

        } else if (state.mode === "summary" && !state.split) {
            // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            const table = makeTable(["‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö", "‡∏Å‡πà‡∏≠‡∏ô VAT", "VAT", "‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥"]);
            state.rows.forEach(r => {
                count += +r.count || 0;
                before += +r.before_vat || 0;
                grand += +r.grand || 0;
                addRow(table.tbody, [
                    r.period || "-",
                    fmtInt(r.count),
                    fmtNum(r.before_vat),
                    fmtNum(r.vat),
                    fmtNum(r.grand)
                ]);
            });
            body.appendChild(table.wrap);

        } else {
            // ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏∑‡πà‡∏ô‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏´‡∏£‡∏∑‡∏≠ detail ‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢)
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ...
        }

        $$("#kCount").textContent = fmtInt(count);
        $$("#kBefore").textContent = fmtNum(before);
        $$("#kGrand").textContent = fmtNum(grand);
    }

    // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö sale_tax_report.jpg
    function makeSaleTaxTable() {
        const table = document.createElement("table");
        table.className = "st-table";
        const thead = document.createElement("thead");
        thead.innerHTML = `
    <tr>
      <th class="c w-idx">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
      <th class="c w-date">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ</th>
      <th class="c w-book">‡πÄ‡∏•‡πà‡∏°‡∏ó‡∏µ‡πà</th>
      <th class="c w-no">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
      <th class="c w-code">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
      <th class="c">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
      <th class="c w-taxid">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏≤‡∏Å‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
      <th class="c w-branch">‡∏™‡∏ñ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£</th>
      <th class="c w-amt">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
      <th class="c w-amt">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</th>
      <th class="c w-amt">‡∏£‡∏ß‡∏°</th>
    </tr>
  `;
        const tbody = document.createElement("tbody");
        table.appendChild(thead);
        table.appendChild(tbody);
        return { table, tbody };
    }

    // ‡πÑ‡∏ó‡∏¢-‡πÄ‡∏î‡∏ó dd/mm/‡∏û.‡∏®.
    function fmtThaiDate(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear() + 543;
        return `${dd}/${mm}/${yy}`;
    }

    /* helpers */
    function makeTable(headers) {
        const wrap = document.createElement("div");
        wrap.className = "overflow-auto";
        const table = document.createElement("table");
        table.className = "table";
        const thead = document.createElement("thead");
        const trh = document.createElement("tr");
        headers.forEach(h => {
            const th = document.createElement("th");
            th.textContent = h;
            trh.appendChild(th);
        });
        thead.appendChild(trh);
        const tbody = document.createElement("tbody");
        table.appendChild(thead); table.appendChild(tbody); wrap.appendChild(table);
        return { wrap, tbody };
    }
    function addRow(tbody, cells) {
        const tr = document.createElement("tr");
        cells.forEach((c, i) => {
            const td = document.createElement("td");
            td.textContent = c;
            if (i >= cells.length - 3) td.className = "text-right";
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }
    function groupBy(arr, keyFn) { return arr.reduce((m, x) => { const k = keyFn(x); (m[k] ||= []).push(x); return m; }, {}); }
    function ymd(d) { return d.toISOString().slice(0, 10); }
    function firstDayOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }
    function lastDayOfMonth(d) { return new Date(d.getFullYear(), d.getMonth() + 1, 0); }
    function fmtNum(n) { n = Number(n || 0); return n.toLocaleString('en-US', { minimumFractionDigits: 2 }); }
    function fmtInt(n) { n = Number(n || 0); return n.toLocaleString('en-US'); }


    document.getElementById("btnExcel").addEventListener("click", exportExcel);

    function exportExcel() {
        // ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô #reportBody ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        const tables = Array.from(document.querySelectorAll("#reportBody table"));
        if (!tables.length) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å"); return; }

        // ‡∏î‡∏∂‡∏á caption ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏´‡∏±‡∏ß‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ä‡∏µ‡∏ï
        const sheets = [];
        tables.forEach((tbl, i) => {
            const headers = Array.from(tbl.querySelectorAll("thead th")).map(th => th.textContent.trim());
            const rows = Array.from(tbl.querySelectorAll("tbody tr")).map(tr =>
                Array.from(tr.children).map(td => td.textContent.trim())
            );
            sheets.push({ name: `Sheet${i + 1}`, headers, rows });
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel (XLS) ‡∏î‡πâ‡∏ß‡∏¢ HTML-Table (Excel ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
        const wb = sheets.map(s => {
            const head = `<tr>${s.headers.map(h => `<th>${escapeXml(h)}</th>`).join("")}</tr>`;
            const body = s.rows.map(r => `<tr>${r.map(c => `<td>${escapeXml(c)}</td>`).join("")}</tr>`).join("");
            return `<table>${head}${body}</table>`;
        }).join("<br/>");

        const html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office"
          xmlns:x="urn:schemas-microsoft-com:office:excel"
          xmlns="http://www.w3.org/TR/REC-html40">
    <head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets>${sheets.map((s, i) => `<x:ExcelWorksheet><x:Name>${"Sheet" + (i + 1)}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>`).join("")
            }</x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head>
    <body>${wb}</body></html>
  `.trim();

        const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "saletax_report.xls";
        a.click();
    }

    function escapeXml(s) { return (s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }

});