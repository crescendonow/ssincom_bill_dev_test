<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>Tax Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ✅ ใช้ไฟล์สไตล์ที่แยกออกมา -->
  <link rel="stylesheet" href="/static/css/invoice.css" />
</head>

<body>

  <div class="doc">
    <!-- head block -->
    <div class="row" style="align-items: flex-start; justify-content: space-between;">
      <!-- ฝั่งซ้าย -->
      <div style="display: flex; flex: 1;">
        <div style="flex:0 0 120px; text-align:center;">
          <img src="/static/ss_logo.png" class="logo" alt="logo" />
          <div class="muted" style="margin-top:4px;"><b>สำนักงานใหญ่:</b></div>
        </div>
        <div
          style="text-align:left; padding-left:10px; display:flex; flex-direction:column; justify-content:flex-start;">
          <div class="title" style="align-self:flex-start;">
            บริษัท เอส แอนด์ เอส อินคอม จำกัด
          </div>
          <div class="title">S &amp; S INCOM CO., LTD.</div>
          <div class="muted9"><b>69 หมู่ 10 ตำบลพังตรุ อำเภอพนมทวน จังหวัดกาญจนบุรี 71140</b></div>
          <div class="muted9"><b>โทร. (035) 589 274, (081) 880 8840, (092) 265 9156</b></div>
          <!-- ✅ ใส่ id ที่บรรทัดอีเมล -->
          <div class="muted" id="company-email" style="font-size:12pt;">
            <b>website: www.ssincom.com</b> <br> Email: mailtossincom@gmail.com
          </div>
        </div>
      </div>

      <!-- ฝั่งขวา -->
      <div id="header-right" style="flex:0 0 auto; text-align:right; align-self:flex-start;">
        {% set variant = (invoice.variant if invoice and invoice.variant is defined else 'invoice_original') %}
        {% set HEADERS = {
        'invoice_original': ['ต้นฉบับใบกำกับภาษี/ใบส่งของ/ใบแจ้งหนี้', 'TAX INVOICE/DELIVERY ORDER /INVOICE ORIGINAL'],
        'receipt_original': ['ต้นฉบับใบเสร็จรับเงิน', 'RECEIPT ORIGINAL'],
        'invoice_copy': ['สำเนาใบกำกับภาษี/ใบส่งของ/ใบแจ้งหนี้', 'COPY TAX INVOICE/DELIVERY ORDER /INVOICE'],
        'receipt_copy': ['สำเนาใบเสร็จรับเงิน', 'RECEIPT COPY']
        } %}
        {% set h = HEADERS.get(variant, HEADERS['invoice_original']) %}

        <div class="title" style="font-size:18pt; white-space:nowrap;">{{ h[0] }}</div>
        <div class="title" style="font-size:14pt; white-space:nowrap;">{{ h[1] }}</div>

        <!-- ✅ เว้นจากบรรทัด TAX... -->
        <div id="tax-label" class="muted" style="margin-top:12px;"><b>เลขประจำตัวผู้เสียภาษีอากร</b></div>

        <!-- ✅ เลขภาษี: จะจัดแนวให้ตรงกับบรรทัดอีเมลด้วย JS -->
        <div class="title" id="tax-id" style="font-size:18pt; white-space:nowrap;">
          0715544000020
        </div>
      </div>
    </div>

    <!-- เส้นคั่น -->
    <hr style="border: 1px solid #0F3F7F; margin: 8px 0;">

    <!-- แถวข้อมูลลูกค้า + เลขที่เอกสาร -->
    <div class="row mt10 align-cols mb8">
      <div class="col box-light col-left" style="font-size:14pt;">
        <div class="mt6">รหัสลูกค้า: <b>{{ invoice.customer_code or invoice.personid }}</b></div>
        <div class="mt6">ชื่อลูกค้า: <b>บริษัท {{ invoice.customer_name }}</b></div>
        <div class="mt6">เลขประจำตัวผู้เสียภาษี: <b>{{ invoice.customer_taxid }}</b> / {{ 'สาขาที่ ' + invoice.cf_branch
          if invoice.cf_branch else 'สำนักงานใหญ่' }}</div>
        <div class="mt6">ที่อยู่: <b>{{ invoice.customer_address }} {{ invoice.cf_provincename or '' }} {{
            invoice.cf_personzipcode or '' }}</b></div>
        <div class="mt6">โทรศัพท์: <b>{{ invoice.tel or invoice.mobile or '' }}</b></div>
      </div>

      <div class="col box-light col-right" style="font-size:14pt;">
        <div>เลขที่: <b>{{ invoice.invoice_number }}</b></div>
        <div class="mt6">วันที่: <b>{{ invoice.invoice_date | thaidate }}</b></div>
        <div class="mt6">เลขที่ใบสั่งซื้อ: <b>{{ invoice.po_number }}</b></div>
        <div class="mt6">
          เงื่อนไขการชำระเงิน:
          <b>
            {{ invoice.fmlpaymentcreditday | default('', true) }}
            {% if invoice.fmlpaymentcreditday %}&nbsp;วัน{% endif %}
          </b>
        </div>

        <div class="mt6">วันครบกำหนดชำระเงิน: <b>{{ invoice.due_date | default(invoice.invoice_date, true) | thaidate
            }}</b></div>
        <div class="mt6">เลขที่ใบรับสินค้า: <b>{{ invoice.grn_number }}</b></div>
        <div class="mt6">เลขที่ใบส่งสินค้า: <b>{{ invoice.dn_number }}</b></div>
      </div>
    </div>

    <!-- ตารางสินค้า -->
    <div class="table-frame">
      <table class="items">
        <thead>
          <tr>
            <th class="center" style="width:6%;">ลำดับ</th>
            <th class="center" style="width:16%;">รหัสสินค้า</th>
            <th class="center">ชื่อสินค้า / รายละเอียด</th>
            <th class="center" style="width:12%;">จำนวน</th>
            <th class="center" style="width:14%;">ราคาต่อหน่วย</th>
            <th class="center" style="width:16%;">จำนวนเงิน</th>
          </tr>
        </thead>
        <tbody>
          {% set ns = namespace(total=0) %}
          {% for item in invoice["items"] %}
          {% set qty = item["quantity"]|float %}
          {% set price = item["unit_price"]|float %}
          {% set amount = qty * price %}
          {% set ns.total = ns.total + amount %}
          <tr>
            <td class="center">{{ loop.index }}</td>
            <td class="center">{{ item["product_code"] }}</td>
            <td>{{ item["description"] }}</td>
            <td class="right">{{ '{:,.2f}'.format(qty) }}</td>
            <td class="right">{{ '{:,.2f}'.format(price) }}</td>
            <td class="right">{{ '{:,.2f}'.format(amount) }}</td>
          </tr>
          {% endfor %}

          {% set filler = 8 - (invoice["items"]|length) %}
          {% for i in range(filler if filler > 0 else 0) %}
          <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- หมายเหตุ + สรุปยอด -->
    <div class="row mt10 align-cols">
      <div class="col box-light col-left">
        <div class="muted"><b>หมายเหตุ</b></div>
        <div class="muted" style="line-height:1.25;">
          โปรดโอนเงินในนาม <b>“บริษัท เอส แอนด์ เอส อินคอม จำกัด”</b> เท่านั้น
          เมื่อพ้นกำหนดการชำระเงิน บริษัทฯ ขอสงวนสิทธิ์คิดดอกเบี้ยอัตราร้อยละ 1.5 ต่อเดือน
          สินค้าที่ยังมิได้ชำระเงินยังเป็นกรรมสิทธิ์ของบริษัท เอส แอนด์ เอส อินคอม จำกัด
          จนกว่าผู้ซื้อจะชำระค่าสินค้าเรียบร้อยแล้ว
          ได้รับสินค้าตามรายการข้างต้นไว้ในสภาพเรียบร้อยเป็นการถูกต้องแล้ว
        </div>
      </div>

      <div class="col col-right">
        {% set discount = (discount|float) if discount is defined else 0.0 %}
        {% set before_vat = ns.total - discount %}
        {% set vat = (vat_rate|float if vat_rate is defined else 7.0) %}
        {% set vat_amt = before_vat * (vat / 100.0) %}

        {# ปัดเศษทศนิยม 2 ตำแหน่งก่อนบวกกัน #}
        {% set before_vat_rounded = (before_vat | round(2, 'common')) %}
        {% set vat_amt_rounded = (vat_amt | round(2, 'common')) %}
        {% set grand = before_vat_rounded + vat_amt_rounded %}

        <div class="box">
          <table class="sumtable" style="width:100%;">
            <tr>
              <td>รวมราคา / Amount</td>
              <td class="right">{{ '{:,.2f}'.format(ns.total) }}</td>
            </tr>
            <tr>
              <td>ส่วนลด / Discount</td>
              <td class="right">{{ '{:,.2f}'.format(discount) }}</td>
            </tr>
            <tr>
              <td>รวมเป็นเงิน / Sub Total</td>
              <td class="right">{{ '{:,.2f}'.format(before_vat_rounded) }}</td>
            </tr>
            <tr>
              <td>ภาษีมูลค่าเพิ่ม / Vat {{ '{:.0f}%'.format(vat) }}</td>
              <td class="right">{{ '{:,.2f}'.format(vat_amt_rounded) }}</td>
            </tr>
            <tr>
              <td><b>จำนวนเงินรวมทั้งสิ้น / Net Total</b></td>
              <td class="right big-amount"><b>{{ '{:,.2f}'.format(grand) }}</b></td>
            </tr>
          </table>
          <div style="text-align:right; margin-top:6px; font-style:italic;">
            ( {{ grand | thbaht }} )
          </div>
        </div>
      </div>
    </div>

    <!-- ลายเซ็น -->
    <div class="row mt14">
      <div class="col center box-light">
        ผู้รับสินค้า / วันที่<br /><br /><br />..................................
      </div>
      <div class="col center box-light">
        ผู้ตรวจสินค้า<br /><br /><br />..................................
      </div>
      <div class="col center box-light">
        ผู้มีอำนาจลงนาม<br /><br /><br />..................................
      </div>
      <div class="col center box-light" style="flex:0 0 220px;">
        ทะเบียนรถจัดส่ง:<br /><br /><b>{{ invoice.car_numberplate}}</b>
      </div>
    </div>
  </div>

  <div class="noprint" style="margin-top:14px; text-align:right;">
    <button onclick="window.print()"
      style="padding:8px 14px; background:#0F3F7F; color:#fff; border:none; border-radius:8px; cursor:pointer;">
      🖨️ พิมพ์ / บันทึก PDF
    </button>
  </div>

  <script src="/static/js/invoice.js"></script>
</body>

</html>